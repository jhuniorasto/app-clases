<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1"
    />
    <meta
      name="description"
      content="Desarrolla una moderna aplicaci贸n web en Angular standalone, conectada a Firebase, para gestionar cursos virtuales."
    />
    <title>EduSmart - Gesti贸n de Cursos Virtuales</title>

    <!-- Estilos Mobirise y Bootstrap -->
    <link
      rel="stylesheet"
      href="https://r.mobirisesite.com/1458871/assets/css/mbr-additional.css"
    />
    <!-- Fuente -->
  </head>

  <body>
    <!DOCTYPE html>
    <html lang="es">
      <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1"
        />
        <meta
          name="description"
          content="Desarrolla una moderna aplicaci贸n web en Angular standalone, conectada a Firebase, para gestionar cursos virtuales."
        />
        <title>EduSmart - Gesti贸n de Cursos Virtuales</title>

        <!-- Estilos Mobirise y Bootstrap -->
        <link
          rel="stylesheet"
          href="https://r.mobirisesite.com/1458871/assets/css/mbr-additional.css"
        />
        <!-- Fuente -->
      </head>

      <body>
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="display-5">
              <strong> Gesti贸n de Usuarios</strong>
            </h3>

            <button class="btn btn-primary" (click)="abrirFormularioNuevo()">
              <i class="bi bi-plus-circle me-1"></i> Nuevo Usuario
            </button>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <label class="form-label">Rol</label>
                  <select
                    class="form-select"
                    [ngModel]="rolFiltroValue"
                    (ngModelChange)="onFiltroChange($event)"
                  >
                    <option value="todos">Todos</option>
                    <option value="admin">Administradores</option>
                    <option value="docente">Docentes</option>
                    <option value="estudiante">Estudiantes</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Buscar</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Nombre o email"
                      [ngModel]="terminoBusquedaValue"
                      (ngModelChange)="onBusqueda($event)"
                    />
                  </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <div class="alert alert-info w-100 mb-0">
                    <i class="bi bi-people me-2"></i>
                    Usuarios encontrados:
                    {{ (usuariosFiltrados$ | async)?.length || 0 }}
                  </div>
                </div>
              </div>

              <div
                class="table-responsive"
                *ngIf="!(cargando$ | async); else loading"
              >
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Nombre</th>
                      <th>Email</th>
                      <th>Rol</th>
                      <th>Estado</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="
                        let usuario of usuariosFiltrados$ | async;
                        trackBy: trackByUid
                      "
                    >
                      <td>
                        <div class="fw-semibold">{{ usuario.nombre }}</div>
                        <small class="text-muted">{{ usuario.uid }}</small>
                      </td>
                      <td>{{ usuario.email }}</td>
                      <td>
                        <span class="badge bg-primary">{{ usuario.rol }}</span>
                      </td>
                      <td>
                        <span
                          class="badge"
                          [ngClass]="
                            usuario.estado?.activo ? 'bg-success' : 'bg-danger'
                          "
                        >
                          {{ usuario.estado?.activo ? "Activo" : "Inactivo" }}
                        </span>
                      </td>
                      <td class="text-end">
                        <div class="btn-group btn-group-sm">
                          <button
                            class="btn btn-outline-primary"
                            (click)="abrirFormularioEditar(usuario)"
                          >
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button
                            class="btn btn-outline-warning"
                            (click)="desactivarUsuario(usuario)"
                            [disabled]="!usuario.estado?.activo"
                          >
                            <i class="bi bi-dash-circle"></i>
                          </button>
                          <button
                            class="btn btn-outline-danger"
                            (click)="eliminarUsuario(usuario)"
                          >
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <div
                  class="text-center py-4 text-muted"
                  *ngIf="(usuariosFiltrados$ | async)?.length === 0"
                >
                  <i class="bi bi-emoji-neutral fs-1 d-block mb-2"></i>
                  No hay usuarios que coincidan con los filtros
                </div>
              </div>

              <ng-template #loading>
                <div class="text-center py-4">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <p class="mt-2">Cargando usuarios...</p>
                </div>
              </ng-template>
            </div>
          </div>

          <div
            class="offcanvas offcanvas-end"
            [class.show]="mostrarFormulario"
            [style.visibility]="mostrarFormulario ? 'visible' : 'hidden'"
          >
            <div class="offcanvas-header">
              <h5 class="offcanvas-title">
                {{ usuarioEditando ? "Editar Usuario" : "Nuevo Usuario" }}
              </h5>
              <button
                type="button"
                class="btn-close"
                (click)="cerrarFormulario()"
              ></button>
            </div>
            <div class="offcanvas-body">
              <form
                [formGroup]="formularioUsuario"
                (ngSubmit)="guardarUsuario()"
              >
                <div class="mb-3">
                  <label class="form-label">Nombre</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="nombre"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    formControlName="email"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label">Rol</label>
                  <select class="form-select" formControlName="rol">
                    <option value="admin">Administrador</option>
                    <option value="docente">Docente</option>
                    <option value="estudiante">Estudiante</option>
                  </select>
                </div>

                <div class="mb-3 form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="activo"
                    formControlName="activo"
                  />
                  <label class="form-check-label" for="activo">Activo</label>
                </div>

                <div class="d-grid gap-2">
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="formularioUsuario.invalid"
                  >
                    <i class="bi bi-save me-1"></i>
                    {{ usuarioEditando ? "Actualizar" : "Crear" }}
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="cerrarFormulario()"
                  >
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </body>
    </html>
  </body>
</html>
